name: è‡ªåŠ¨åŒæ­¥ä¸Šæ¸¸

on:
  schedule:
    # æ¯å¤© UTC 02:00ï¼ˆåŒ—äº¬æ—¶é—´ 10:00ï¼‰è‡ªåŠ¨åŒæ­¥
    - cron: '0 2 * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write

    steps:
      - name: Checkout ä»£ç 
        uses: actions/checkout@v4
        with:
          ref: deploy
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: é…ç½® Git ç”¨æˆ·
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: åŒæ­¥ä¸Šæ¸¸ QuantumNous/new-api
        run: |
          echo "ğŸ”„ å¼€å§‹åŒæ­¥ä¸Šæ¸¸ä»“åº“..."
          git remote add upstream https://github.com/QuantumNous/new-api.git || true
          git fetch upstream

          echo "ğŸ“Š ä¸Šæ¸¸æ–°æäº¤ï¼š"
          git log --oneline deploy..upstream/main | head -10 || echo "æ— æ–°æäº¤"

          # æ£€æŸ¥æ˜¯å¦æœ‰æ–°æäº¤
          if [ "$(git rev-parse deploy)" = "$(git merge-base deploy upstream/main)" ] && [ "$(git rev-parse upstream/main)" = "$(git rev-parse deploy)" ]; then
            echo "âœ… å·²æ˜¯æœ€æ–°ï¼Œæ— éœ€åŒæ­¥"
            exit 0
          fi

          echo "ğŸ”€ åˆå¹¶ä¸Šæ¸¸ä»£ç ..."
          if git merge upstream/main --no-edit; then
            echo "âœ… åˆå¹¶æˆåŠŸ"
            git push origin deploy
            echo "ğŸš€ å·²æ¨é€åˆ° GitHub"
          else
            echo "âŒ åˆå¹¶å¤±è´¥ï¼Œå¯èƒ½æœ‰å†²çª"
            git merge --abort
            exit 1
          fi

      - name: ç”ŸæˆåŒæ­¥æŠ¥å‘Š
        if: success()
        run: |
          echo "## âœ… åŒæ­¥æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ä¸Šæ¸¸ä»“åº“**: QuantumNous/new-api" >> $GITHUB_STEP_SUMMARY
          echo "**åŒæ­¥æ—¶é—´**: $(date +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### æœ€è¿‘æäº¤" >> $GITHUB_STEP_SUMMARY
          git log --oneline HEAD~5..HEAD >> $GITHUB_STEP_SUMMARY || true

      - name: åŒæ­¥å¤±è´¥é€šçŸ¥
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'âš ï¸ ä¸Šæ¸¸åŒæ­¥å¤±è´¥ - ' + new Date().toISOString().split('T')[0],
              body: `## åŒæ­¥å¤±è´¥æŠ¥å‘Š\n\n**å¤±è´¥æ—¶é—´**: ${new Date().toISOString()}\n**Workflow è¿è¡Œ**: ${context.payload.repository.html_url}/actions/runs/${context.runId}\n\n### å¯èƒ½åŸå› \n\n- deploy åˆ†æ”¯çš„è‡ªå®šä¹‰è¡¥ä¸ä¸ä¸Šæ¸¸ä»£ç å†²çª\n- ä¸Šæ¸¸ä»“åº“æš‚æ—¶ä¸å¯è®¿é—®\n\n### å½“å‰è¡¥ä¸\n\n- Dockerfile: GOPROXY åŠ é€Ÿ\n- stream_scanner.go: channel å†™å…¥è¶…æ—¶ 10s â†’ 600s\n\n### å»ºè®®æ“ä½œ\n\n1. æŸ¥çœ‹ [Actions æ—¥å¿—](${context.payload.repository.html_url}/actions/runs/${context.runId}) äº†è§£è¯¦ç»†é”™è¯¯\n2. æœ¬åœ°æ‰‹åŠ¨è§£å†³å†²çªï¼š\n   \`\`\`bash\n   cd ~/github/new-api && git checkout deploy\n   git fetch origin && git merge origin/main\n   # è§£å†³å†²çªå\n   git push fork deploy\n   \`\`\``
            })
